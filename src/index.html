<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Visualization</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
            integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
            crossorigin="anonymous"></script>
</head>
<body class="vh-100 m-0 p-0">

<div class="container-fluid h-100 overflow-y-hidden">
    <div class="row h-100">
        <div class="col-md-4 col-lg-3 border-end pt-3 px-4 bg-light">
            <h2 class="mb-3"><b>GRA</b> Visualization</h2>

            <div class="btn-group btn-block mb-2" role="group" aria-label="Basic example">
                <button type="button" id="newVertexButton" class="btn btn-primary btn-change-gra-mode active"
                        data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="bottom"
                        title="Add Vertex" data-bs-content="Click to add a new vertex">
                    <i class="bi bi-plus-circle-fill"></i>
                </button>
                <button type="button" id="createEdgeButton" class="btn btn-primary btn-change-gra-mode"
                        data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="bottom" title="Add Edge"
                        data-bs-content="Hold down on a vertex and drag to another vertex to create an edge, or drag into empty space to create a new vertex.">
                    <i class="bi bi-node-plus-fill"></i>
                </button>
                <button type="button" id="createEdgeRedirectButton" class="btn btn-primary btn-change-gra-mode"
                        data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="bottom"
                        title="Add Redirected Edge"
                        data-bs-content="Hold down on a vertex and drag into empty space continuously until you reach a desired vertex to create multiple redirection points, connected by a single logical edge.">
                    <i class="bi bi-share-fill"></i>
                </button>
                <button type="button" id="moveVertexButton" class="btn btn-secondary btn-change-gra-mode"
                        data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="bottom"
                        title="Move Vertex" data-bs-content="Click and drag a vertex to move it.">
                    <i class="bi bi-arrows-move"></i>
                </button>
                <button type="button" id="removeElementButton" class="btn btn-warning btn-change-gra-mode"
                        data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="bottom"
                        title="Remove Element" data-bs-content="Click on a vertex or edge to remove it.">
                    <i class="bi bi-ban"></i>
                </button>
                <button type="button" id="removeAllElementsButton" class="btn btn-danger btn-change-gra-mode"
                        data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="bottom"
                        title="Clear Graph" data-bs-content="Click to remove all vertices and edges.">
                    <i class="bi bi-trash-fill"></i>
                </button>
            </div>
            <br>

            <div class="btn-group btn-block mb-2" role="group" aria-label="Visualization Options"
                 id="visualizationOptions">
            </div>

            <p class="text-center mt-3" style="font-size: 24px;" id="formulaText">
                <span id="fvalue" style="color: #006fff; font-weight: bold;"
                      data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="bottom"
                      title="Euler's Formula"
                      data-bs-content="f is the number of faces in the graph. Euler's formula states that f = |K| - |E| + 2.">
                </span>
                = <span id="Kvalue" style="color: #ff2d0f; font-weight: bold;"
                        data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="bottom"
                        title="Euler's Formula"
                        data-bs-content="|K| is the number of edges in the graph. Euler's formula states that f = |K| - |E| + 2.">
                </span>
                - <span id="Evalue" style="color: #04a100; font-weight: bold;"
                        data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="bottom"
                        title="Euler's Formula"
                        data-bs-content="|E| is the number of vertices in the graph. Euler's formula states that f = |K| - |E| + 2.">
            </span> + 2
            </p>

            <script>
                function updateFormula(K, E, f) {
                    const isEmpty = (value) => value === undefined || value === null || value === 0;

                    if (isEmpty(K) && isEmpty(E)) {
                        document.getElementById('Kvalue').textContent = '|K|';
                        document.getElementById('Evalue').textContent = '|E|';
                        document.getElementById('fvalue').textContent = 'f';
                        document.getElementById('formulaText').classList.remove('invalid');
                    } else {
                        document.getElementById('Kvalue').textContent = K;
                        document.getElementById('Evalue').textContent = E;
                        document.getElementById('fvalue').textContent = f;

                        // check if the formula is valid
                        if (K - E + 2 === f) {
                            document.getElementById('formulaText').classList.remove('invalid');
                        } else {
                            document.getElementById('formulaText').classList.add('invalid');
                        }
                    }
                }

                updateFormula(0, 0, 0);
            </script>
        </div>
        <div class="col-md-8 col-lg-9 p-0">
            <canvas id="graphCanvas" class="w-100 h-100"></canvas>
        </div>
    </div>
</div>

<footer class="py-2 bg-light fixed-bottom">
    <div class="container text-center">
        <span class="text-muted d-block mb-1">
            &copy; 2024 Yan Wittmann&nbsp;&nbsp;â—¦&nbsp;&nbsp;
            <a href="#" class="link-secondary text-decoration-none">GitHub Repository</a>
        </span>
    </div>
</footer>

<script src="js/graph-sim.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', function () {
        const graphSim = initializeGraphSim('graphCanvas');

        document.getElementById('newVertexButton').addEventListener('click', function () {
            graphSim.changeMode(Mode.ADD_VERTEX);
        });
        document.getElementById('createEdgeButton').addEventListener('click', function () {
            graphSim.changeMode(Mode.ADD_EDGE);
        });
        document.getElementById('createEdgeRedirectButton').addEventListener('click', function () {
            graphSim.changeMode(Mode.ADD_EDGE_REDIRECT);
        });
        document.getElementById('removeElementButton').addEventListener('click', function () {
            graphSim.changeMode(Mode.REMOVE_ELEMENT);
        });
        document.getElementById('moveVertexButton').addEventListener('click', function () {
            graphSim.changeMode(Mode.MOVE_VERTEX);
        });
        document.getElementById('removeAllElementsButton').addEventListener('click', function () {
            if (confirm('Are you sure you want to remove all vertices and edges?')) {
                graphSim.clearGraph();
            }
        });

        graphSim.addModeChangedListener(function (mode) {
            const buttons = document.querySelectorAll('.btn-change-gra-mode');
            buttons.forEach(function (button) {
                button.classList.remove('active');
            });

            switch (mode) {
                case Mode.ADD_VERTEX:
                    document.getElementById('newVertexButton').classList.add('active');
                    break;
                case Mode.ADD_EDGE:
                    document.getElementById('createEdgeButton').classList.add('active');
                    break;
                case Mode.ADD_EDGE_REDIRECT:
                    document.getElementById('createEdgeRedirectButton').classList.add('active');
                    break;
                case Mode.REMOVE_ELEMENT:
                    document.getElementById('removeElementButton').classList.add('active');
                    break;
                case Mode.MOVE_VERTEX:
                    document.getElementById('moveVertexButton').classList.add('active');
                    break;
            }
        });

        const visualizationOptionsLabels = [
            { option: 'showVertices', label: 'Show Vertices', icon: 'bi bi-circle-fill' },
            { option: 'showEdges', label: 'Show Edges', icon: 'bi bi-link-45deg' },
            { option: 'showPolygons', label: 'Show Polygons', icon: 'bi bi-pentagon-fill' },
            {
                option: 'showIntersections',
                label: 'Show Intersections and Redirect points',
                icon: 'bi bi-bounding-box-circles'
            },
            { option: 'showPolygonIndices', label: 'Show Polygon Indices', icon: 'bi bi-list-ol' },
        ];
        const visualizationOptionsContainer = document.getElementById('visualizationOptions');

        visualizationOptionsLabels.forEach(({ option, label }) => {
            const button = document.createElement('button');
            button.classList.add('btn', 'btn-secondary', 'btn-block', 'btn-sm');
            button.id = 'btn-option-' + option;
            button.title = label;

            // initialize the button with a popover
            button.setAttribute('data-bs-toggle', 'popover');
            button.setAttribute('data-bs-trigger', 'hover');
            button.setAttribute('data-bs-placement', 'bottom');

            const icon = document.createElement('i');
            icon.className = icon.className + visualizationOptionsLabels.find((item) => item.option === option).icon;
            button.appendChild(icon);

            button.addEventListener('click', () => {
                graphSim.visualizationOptions[option] = !graphSim.visualizationOptions[option];
                button.classList.toggle('active');
                graphSim.drawGraph();
            });
            visualizationOptionsContainer.appendChild(button);
        });

        const updateVisualizationOptions = () => {
            // get the visualization options and update active state of the buttons
            const visualizationOptions = graphSim.visualizationOptions;
            visualizationOptionsLabels.forEach(({ option }) => {
                const button = document.getElementById('btn-option-' + option);
                if (button) {
                    if (visualizationOptions[option]) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                }
            });
        }

        graphSim.addUpdateListener((graph) => {
            const K = graph.edges
                .filter(edge => edge.countTowardsTotal !== false)
                .length;
            const E = graph.vertices.length;
            const f = graph.polygons.length + 1; // outside face
            updateFormula(K, E, f);
            updateVisualizationOptions();

            // save to local storage
            if (graph.edges.length > 0) {
                localStorage.setItem('gra-vis-graph-edges', JSON.stringify(graph.edges));
            } else {
                localStorage.removeItem('gra-vis-graph-edges');
            }
            if (graph.vertices.length > 0) {
                localStorage.setItem('gra-vis-graph-vertices', JSON.stringify(graph.vertices));
            } else {
                localStorage.removeItem('gra-vis-graph-vertices');
            }
            if (graph.nonExistentVertices.length > 0) {
                localStorage.setItem('gra-vis-graph-non-existent-vertices', JSON.stringify(graph.nonExistentVertices));
            } else {
                localStorage.removeItem('gra-vis-graph-non-existent-vertices');
            }
        });
        updateVisualizationOptions();
        graphSim.changeMode(Mode.ADD_VERTEX);

        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl)
        });

        // attempt to load from local storage
        if (localStorage.getItem('gra-vis-graph-edges') || localStorage.getItem('gra-vis-graph-vertices') || localStorage.getItem('gra-vis-graph-non-existent-vertices')) {
            let edges = localStorage.getItem('gra-vis-graph-edges');
            let vertices = localStorage.getItem('gra-vis-graph-vertices');
            let nonExistentVertices = localStorage.getItem('gra-vis-graph-non-existent-vertices');
            edges = edges ? JSON.parse(edges) : [];
            vertices = vertices ? JSON.parse(vertices) : [];
            nonExistentVertices = nonExistentVertices ? JSON.parse(nonExistentVertices) : [];
            graphSim.loadGraph(vertices, edges, nonExistentVertices);
        }
    });
</script>
</body>
</html>