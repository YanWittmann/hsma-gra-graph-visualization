<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Visualization</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="vh-100 m-0 p-0">

<div class="container-fluid h-100 overflow-y-hidden">
    <div class="row h-100">
        <div class="col-md-4 col-lg-3 border-end pt-3 px-4 bg-light">
            <h2 class="mb-3"><b>GRA</b> Visualization</h2>

            <div class="btn-group btn-block mb-2" role="group" aria-label="Basic example">
                <button type="button" id="newVertexButton" class="btn btn-primary btn-change-gra-mode active">
                    <i class="bi bi-plus-circle-fill"></i>
                </button>
                <button type="button" id="createEdgeButton" class="btn btn-primary btn-change-gra-mode">
                    <i class="bi bi-link-45deg"></i>
                </button>
                <button type="button" id="removeElementButton" class="btn btn-danger btn-change-gra-mode">
                    <i class="bi bi-trash-fill"></i>
                </button>
                <button type="button" id="moveVertexButton" class="btn btn-secondary btn-change-gra-mode">
                    <i class="bi bi-arrows-move"></i>
                </button>
            </div>
            <br>

            <div class="btn-group btn-block mb-2" role="group" aria-label="Visualization Options"
                 id="visualizationOptions">
            </div>

            <p class="text-center mt-3" style="font-size: 24px;" id="formulaText">
                <span id="fvalue" style="color: #006fff; font-weight: bold;"></span>
                = <span id="Kvalue" style="color: #ff2d0f; font-weight: bold;"></span>
                - <span id="Evalue" style="color: #04a100; font-weight: bold;"></span> + 2
            </p>

            <script>
                function updateFormula(K, E, f) {
                    const isEmpty = (value) => value === undefined || value === null || value === 0;

                    if (isEmpty(K) && isEmpty(E)) {
                        document.getElementById('Kvalue').textContent = '|K|';
                        document.getElementById('Evalue').textContent = '|E|';
                        document.getElementById('fvalue').textContent = 'f';
                    } else {
                        document.getElementById('Kvalue').textContent = K;
                        document.getElementById('Evalue').textContent = E;
                        document.getElementById('fvalue').textContent = f;

                        // check if the formula is valid
                        if (K - E + 2 === f) {
                            document.getElementById('formulaText').classList.remove('invalid');
                        } else {
                            document.getElementById('formulaText').classList.add('invalid');
                        }
                    }
                }

                updateFormula(0, 0, 0);
            </script>
        </div>
        <div class="col-md-8 col-lg-9 p-0">
            <canvas id="graphCanvas" class="w-100 h-100"></canvas>
        </div>
    </div>
</div>

<footer class="py-2 bg-light fixed-bottom">
    <div class="container text-center">
        <span class="text-muted d-block mb-1">
            &copy; 2024 Yan Wittmann&nbsp;&nbsp;â—¦&nbsp;&nbsp;
            <a href="#" class="link-secondary text-decoration-none">GitHub Repository</a>
        </span>
    </div>
</footer>

<script src="js/graph-sim.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', function () {
        const graphSim = initializeGraphSim('graphCanvas');

        document.getElementById('newVertexButton').addEventListener('click', function () {
            graphSim.changeMode(Mode.ADD_VERTEX);
        });
        document.getElementById('createEdgeButton').addEventListener('click', function () {
            graphSim.changeMode(Mode.ADD_EDGE);
        });
        document.getElementById('removeElementButton').addEventListener('click', function () {
            graphSim.changeMode(Mode.REMOVE_ELEMENT);
        });
        document.getElementById('moveVertexButton').addEventListener('click', function () {
            graphSim.changeMode(Mode.MOVE_VERTEX);
        });

        graphSim.addModeChangedListener(function (mode) {
            const buttons = document.querySelectorAll('.btn-change-gra-mode');
            buttons.forEach(function (button) {
                button.classList.remove('active');
            });

            switch (mode) {
                case Mode.ADD_VERTEX:
                    document.getElementById('newVertexButton').classList.add('active');
                    break;
                case Mode.ADD_EDGE:
                    document.getElementById('createEdgeButton').classList.add('active');
                    break;
                case Mode.REMOVE_ELEMENT:
                    document.getElementById('removeElementButton').classList.add('active');
                    break;
                case Mode.MOVE_VERTEX:
                    document.getElementById('moveVertexButton').classList.add('active');
                    break;
            }
        });

        const visualizationOptionsLabels = [
            { option: 'showVertices', label: 'Show Vertices', icon: 'bi bi-circle-fill' },
            { option: 'showEdges', label: 'Show Edges', icon: 'bi bi-link-45deg' },
            { option: 'showPolygons', label: 'Show Polygons', icon: 'bi bi-pentagon-fill' },
            { option: 'showIntersections', label: 'Show Intersections', icon: 'bi bi-bounding-box-circles' },
            { option: 'showPolygonIndices', label: 'Show Polygon Indices', icon: 'bi bi-list-ol' },
        ];
        const visualizationOptionsContainer = document.getElementById('visualizationOptions');

        visualizationOptionsLabels.forEach(({ option, label }) => {
            const button = document.createElement('button');
            button.classList.add('btn', 'btn-secondary', 'btn-block', 'btn-sm');
            button.id = 'btn-option-' + option;

            const icon = document.createElement('i');
            icon.className = icon.className + visualizationOptionsLabels.find((item) => item.option === option).icon;
            button.appendChild(icon);

            button.addEventListener('click', () => {
                graphSim.visualizationOptions[option] = !graphSim.visualizationOptions[option];
                button.classList.toggle('active');
                graphSim.drawGraph();
            });
            visualizationOptionsContainer.appendChild(button);
        });

        const updateVisualizationOptions = () => {
            // get the visualization options and update active state of the buttons
            const visualizationOptions = graphSim.visualizationOptions;
            visualizationOptionsLabels.forEach(({ option }) => {
                const button = document.getElementById('btn-option-' + option);
                if (button) {
                    if (visualizationOptions[option]) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                }
            });
        }

        graphSim.addUpdateListener((graph) => {
            const K = graph.edges
                .filter(edge => edge.countTowardsTotal !== false)
                .length;
            const E = graph.vertices.length;
            const f = graph.polygons.length + 1; // outside face
            updateFormula(K, E, f);
            updateVisualizationOptions();
        });
        updateVisualizationOptions();
    });
</script>
</body>
</html>